# Frontend + Backend Integration Guide

## Quick Integration Steps

### Step 1: Install Flask-CORS
```bash
pip install flask-cors
```

### Step 2: Build Frontend
```bash
cd frontend
npm run build
```
This creates a `frontend/dist` folder with compiled React app.

### Step 3: Update Backend `app.py`

Replace your current imports section with:
```python
from flask_cors import CORS
from flask import send_from_directory  # Add this import
```

Then add after `app = Flask(__name__)`:
```python
# Setup paths
PROJECT_ROOT = Path(__file__).parent.parent
FRONTEND_BUILD = PROJECT_ROOT / "frontend" / "dist"

# Create Flask app with static files
app = Flask(
    __name__,
    static_folder=str(FRONTEND_BUILD),
    static_url_path=""
)

# Enable CORS
CORS(app, resources={r"/api/*": {"origins": "*"}})
```

### Step 4: Add Frontend Routes to Backend

Add these routes at the beginning of your route definitions:

```python
# ============================================================================
# FRONTEND ROUTES (Serve React app)
# ============================================================================

@app.route('/')
def serve_index():
    """Serve index.html for SPA"""
    return send_from_directory(FRONTEND_BUILD, 'index.html')


@app.route('/<path:filename>')
def serve_static(filename):
    """Serve static files (JS, CSS, images)"""
    return send_from_directory(FRONTEND_BUILD, filename)


# Catch-all for SPA routing - serve index.html for all non-API routes
@app.route('/<path:path>')
def serve_spa(path):
    """Serve frontend for all non-API routes (SPA routing)"""
    if path.startswith('api/'):
        return jsonify({"status": "error", "message": "Endpoint not found"}), 404
    
    # Serve index.html for all other routes (React Router will handle routing)
    frontend_index = FRONTEND_BUILD / 'index.html'
    if frontend_index.exists():
        return send_from_directory(FRONTEND_BUILD, 'index.html')
    else:
        return jsonify({
            "status": "error",
            "message": "Frontend not built. Run: cd frontend && npm run build"
        }), 404
```

### Step 5: Update API Routes to Use `/api` Prefix

Change all your API routes from:
```python
@app.route('/health', methods=['GET'])
```

To:
```python
@app.route('/api/health', methods=['GET'])
```

Do this for all API endpoints:
- `/api/health`
- `/api/trigger`
- `/api/status`
- `/api/threat-log`
- `/api/jammer/deactivate`

### Step 6: Update Frontend API Calls

Create a file `frontend/src/lib/api.ts`:

```typescript
const API_BASE = process.env.NODE_ENV === 'production' 
  ? '' 
  : 'http://localhost:5000';

export const apiCall = async (endpoint: string, options?: RequestInit) => {
  const response = await fetch(`${API_BASE}/api${endpoint}`, {
    headers: {
      'Content-Type': 'application/json',
      ...options?.headers,
    },
    ...options,
  });

  if (!response.ok) {
    throw new Error(`API Error: ${response.statusText}`);
  }

  return response.json();
};

export const api = {
  health: () => apiCall('/health'),
  trigger: (data: any) => apiCall('/trigger', { 
    method: 'POST', 
    body: JSON.stringify(data) 
  }),
  getStatus: () => apiCall('/status'),
  getThreatLog: () => apiCall('/threat-log'),
  clearThreatLog: () => apiCall('/threat-log', { method: 'DELETE' }),
  deactivateJammer: () => apiCall('/jammer/deactivate', { method: 'POST' }),
};
```

Then use in components:
```typescript
import { api } from '@/lib/api';

// Get status
const status = await api.getStatus();

// Trigger response
await api.trigger({ threat_detected: true, detection: {...} });
```

### Step 7: Update Vite Config for Dev Proxy

In `frontend/vite.config.ts`:

```typescript
export default defineConfig({
  // ... existing config ...
  server: {
    proxy: {
      '/api': {
        target: 'http://localhost:5000',
        changeOrigin: true,
      }
    }
  }
});
```

### Step 8: Run Combined System

**Terminal 1 - Backend:**
```bash
python backend/app.py
# Now running on http://localhost:5000
```

**Terminal 2 - Frontend Development (Optional):**
```bash
cd frontend
npm run dev
# Frontend will proxy API calls to backend
```

Or just build once and use the backend-served version.

---

## Directory Structure After Integration

```
AeroGuardAI/
├── backend/
│   ├── app.py (UPDATED - serves frontend + API)
│   ├── jammer_sim.py
│   ├── email_alert.py
│   └── __init__.py
│
├── frontend/
│   ├── dist/                    (← Generated by build)
│   │   ├── index.html
│   │   ├── assets/
│   │   └── ...
│   ├── src/
│   ├── package.json
│   ├── vite.config.ts (UPDATED - dev proxy)
│   └── ...
│
└── runs/
    └── detect/train/weights/
        └── best.pt
```

---

## API Endpoints

All endpoints are prefixed with `/api`:

| Method | Endpoint | Purpose |
|--------|----------|---------|
| GET | `/api/health` | Check if server is running |
| POST | `/api/trigger` | Trigger threat response |
| GET | `/api/status` | Get system status |
| GET | `/api/threat-log` | Get threat history |
| DELETE | `/api/threat-log` | Clear threat history |
| POST | `/api/jammer/deactivate` | Disable jammer |

---

## Development vs Production

### Development
- Frontend: `npm run dev` (Vite dev server with hot reload)
- Backend: `python app.py`
- API calls: Proxied via Vite to backend

### Production
```bash
# Build frontend
cd frontend && npm run build

# Run backend (serves built frontend)
python backend/app.py
```

Only need to run one command in production!

---

## Troubleshooting

**Q: "Frontend not found" error**
- A: Run `cd frontend && npm run build` first

**Q: CORS errors in browser**
- A: Make sure `CORS(app)` is in your `app.py`

**Q: API calls returning 404**
- A: Make sure all endpoints have `/api/` prefix

**Q: React Router not working**
- A: Make sure the catch-all route serves `index.html` for SPA routing

---

## Summary

✓ Backend serves frontend  
✓ Single port (5000)  
✓ One command to run production  
✓ Hot reload in development  
✓ API calls automatically routed
